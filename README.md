# MySpice

ä¸€ä¸ªåŸºäº Rust çš„ SPICE ä»¿çœŸå™¨é¡¹ç›®ï¼Œç›®æ ‡æ˜¯å…ˆæ”¯æŒ DC + åŸºæœ¬å™¨ä»¶ï¼ˆå« MOSFETï¼‰ï¼Œå¹¶åœ¨æ¶æ„ä¸Šé¢„ç•™ BSIM æ¨¡å‹ã€äº¤äº’å¼ APIã€AI ä»£ç†ä¸å¯è§†åŒ–ç•Œé¢çš„æ‰©å±•èƒ½åŠ›ã€‚

## ç›®æ ‡ä¸é˜¶æ®µ

- é˜¶æ®µ A: DC + åŸºç¡€å™¨ä»¶ + MOSFETï¼ˆBSIM ç»“æ„å ä½ï¼‰
- é˜¶æ®µ B: å°è§„æ¨¡åˆ°å¤§è§„æ¨¡ç½‘è¡¨çš„æ€§èƒ½æ‰©å±•
- é˜¶æ®µ C: å¤šç§è¾“å‡ºæ ¼å¼ï¼ˆPSF æ–‡æœ¬ã€ngspice rawã€PSF/FSDB ç­‰ï¼‰

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           sim-cli (åº”ç”¨å±‚)                           â”‚
â”‚                        å‘½ä»¤è¡Œå·¥å…·å…¥å£                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           sim-api (API å±‚)                          â”‚
â”‚                schema.rs â”‚ session_api.rs â”‚ http.rs                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          sim-core (æ ¸å¿ƒå±‚)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ netlist  â”‚ circuit  â”‚  engine  â”‚  newton  â”‚ result   â”‚          â”‚
â”‚  â”‚ ç½‘è¡¨è§£æ â”‚ ç”µè·¯ç»“æ„ â”‚ ä»¿çœŸå¼•æ“ â”‚ éçº¿æ€§   â”‚ ç»“æœå­˜å‚¨ â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚   mna    â”‚  stamp   â”‚      solver        â”‚   psf    â”‚          â”‚
â”‚  â”‚ çŸ©é˜µæ„å»º â”‚ å™¨ä»¶è´¡çŒ® â”‚     çº¿æ€§æ±‚è§£       â”‚ ç»“æœè¾“å‡º â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        sim-devices (åŸºç¡€å±‚)                          â”‚
â”‚         passive.rs â”‚ source.rs â”‚ diode.rs â”‚ mosfet.rs              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚è¯´æ˜

| å±‚çº§ | Crate | èŒè´£ |
|------|-------|------|
| åº”ç”¨å±‚ | sim-cli | å‘½ä»¤è¡Œå·¥å…·å…¥å£ |
| API å±‚ | sim-api | HTTP API æœåŠ¡ã€Schema å®šä¹‰ |
| æ ¸å¿ƒå±‚ | sim-core | ç½‘è¡¨è§£æã€MNA æ„å»ºã€æ±‚è§£ã€ç»“æœç®¡ç† |
| åŸºç¡€å±‚ | sim-devices | å™¨ä»¶æ¨¡å‹ï¼ˆR/C/L/V/I/D/MOSï¼‰ |

### ä¾èµ–å…³ç³»

```
sim-cli
  â””â”€> sim-api
        â””â”€> sim-core
              â””â”€> sim-devices
```

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### sim-core æ¨¡å—ç»“æ„

```
sim-core/src/
â”œâ”€â”€ lib.rs           # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ netlist.rs       # ç½‘è¡¨è§£æï¼ˆASTã€å­ç”µè·¯å±•å¼€ã€å‚æ•°æ›¿æ¢ï¼‰
â”œâ”€â”€ circuit.rs       # ç”µè·¯æ•°æ®ç»“æ„ï¼ˆèŠ‚ç‚¹è¡¨ã€æ¨¡å‹è¡¨ã€å®ä¾‹è¡¨ï¼‰
â”œâ”€â”€ topology.rs      # æ‹“æ‰‘åˆ†æï¼ˆå ä½ï¼‰
â”œâ”€â”€ mna.rs           # MNA çŸ©é˜µæ„å»ºï¼ˆSparseBuilderã€AuxVarTableï¼‰
â”œâ”€â”€ stamp.rs         # å™¨ä»¶ Stampï¼ˆDC/TRAN æ¨¡å¼ï¼‰
â”œâ”€â”€ solver.rs        # çº¿æ€§æ±‚è§£å™¨ï¼ˆDenseSolverã€KluSolverï¼‰
â”œâ”€â”€ newton.rs        # Newton è¿­ä»£ï¼ˆgmin/source steppingï¼‰
â”œâ”€â”€ engine.rs        # ä»¿çœŸå¼•æ“ï¼ˆDCã€TRAN åˆ†æï¼‰
â”œâ”€â”€ analysis.rs      # åˆ†æé…ç½®ï¼ˆæ—¶é—´æ­¥æ§åˆ¶ã€è¯¯å·®ä¼°è®¡ï¼‰
â”œâ”€â”€ result_store.rs  # ç»“æœå­˜å‚¨ç®¡ç†
â”œâ”€â”€ psf.rs           # PSF æ ¼å¼è¾“å‡º
â””â”€â”€ session.rs       # ä¼šè¯ç®¡ç†
```

### æ¨¡å—åŠŸèƒ½è¯´æ˜

| æ¨¡å— | æ ¸å¿ƒç»“æ„/å‡½æ•° | åŠŸèƒ½ |
|------|--------------|------|
| `netlist.rs` | `parse_netlist()`, `elaborate_netlist()` | è§£æç½‘è¡¨ã€å±•å¼€å­ç”µè·¯ã€å‚æ•°æ›¿æ¢ |
| `circuit.rs` | `Circuit`, `NodeTable`, `AnalysisCmd` | ç”µè·¯ä¸­é—´è¡¨ç¤º |
| `mna.rs` | `MnaBuilder`, `SparseBuilder`, `AuxVarTable` | æ„å»º MNA ç¨€ç–çŸ©é˜µ |
| `stamp.rs` | `DeviceStamp` trait, `InstanceStamp` | å„å™¨ä»¶å¯¹çŸ©é˜µçš„è´¡çŒ® |
| `solver.rs` | `LinearSolver` trait, `DenseSolver`, `KluSolver` | çº¿æ€§æ–¹ç¨‹ç»„æ±‚è§£ |
| `newton.rs` | `run_newton_with_stepping()` | éçº¿æ€§è¿­ä»£æ”¶æ•› |
| `engine.rs` | `Engine`, `run_dc_result()`, `run_tran_result()` | æ‰§è¡Œ DC/TRAN ä»¿çœŸ |
| `result_store.rs` | `ResultStore`, `RunResult` | ç®¡ç†ä»¿çœŸç»“æœ |

### å…³é”® Trait è®¾è®¡

```rust
// çº¿æ€§æ±‚è§£å™¨æ¥å£ (solver.rs)
pub trait LinearSolver {
    fn prepare(&mut self, n: usize);
    fn analyze(&mut self, ap: &[i64], ai: &[i64]) -> Result<(), SolverError>;
    fn factor(&mut self, ap: &[i64], ai: &[i64], ax: &[f64]) -> Result<(), SolverError>;
    fn solve(&mut self, rhs: &mut [f64]) -> Result<(), SolverError>;
    fn reset_pattern(&mut self);
}

// å™¨ä»¶ Stamp æ¥å£ (stamp.rs)
pub trait DeviceStamp {
    fn stamp_dc(&self, ctx: &mut StampContext, solution: Option<&[f64]>) -> Result<(), String>;
    fn stamp_tran(&self, ctx: &mut StampContext, solution: Option<&[f64]>, 
                  dt: f64, state: &mut TransientState) -> Result<(), String>;
}
```

## æ•°æ®æµå‘

```
ç½‘è¡¨æ–‡ä»¶ (.cir)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ netlist::parse_netlist()          â”‚  è§£æä¸º AST
â”‚ netlist::elaborate_netlist()      â”‚  å±•å¼€å­ç”µè·¯ã€å‚æ•°æ›¿æ¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ circuit::Circuit                  â”‚  æ„å»ºç”µè·¯æ•°æ®ç»“æ„
â”‚ (NodeTable, InstanceTable, ...)   â”‚  èŠ‚ç‚¹/å®ä¾‹/æ¨¡å‹è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ engine::Engine                    â”‚  ä»¿çœŸå¼•æ“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€ DC åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚   â”‚ 1. mna::MnaBuilder æ„å»ºç¨€ç–çŸ©é˜µ         â”‚ â”‚
    â”‚   â”‚ 2. stamp::InstanceStamp è´¡çŒ®å™¨ä»¶æ–¹ç¨‹    â”‚ â”‚
    â”‚   â”‚ 3. solver::DenseSolver åˆ†è§£æ±‚è§£         â”‚ â”‚
    â”‚   â”‚ 4. newton::run_newton_with_stepping    â”‚ â”‚
    â”‚   â”‚    â””â”€â”€ gmin stepping â†’ source stepping â”‚ â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                â”‚
    â”œâ”€â”€â”€ TRAN åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚   â”‚ æ—¶é—´æ­¥å¾ªç¯:                             â”‚ â”‚
    â”‚   â”‚   1. æ„å»º MNA (å« C/L ç­‰æ•ˆ)             â”‚ â”‚
    â”‚   â”‚   2. Newton è¿­ä»£æ±‚è§£                    â”‚ â”‚
    â”‚   â”‚   3. è¯¯å·®ä¼°è®¡ + è‡ªé€‚åº”æ­¥é•¿              â”‚ â”‚
    â”‚   â”‚   4. æ›´æ–°ç¬æ€çŠ¶æ€                       â”‚ â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                                â”‚
    â–¼                                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ result_store::ResultStore         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (RunResult, èŠ‚ç‚¹ç”µå‹/ç”µæµ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ psf::write_psf_text()             â”‚  è¾“å‡ºç»“æœæ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å½“å‰å®ç°çŠ¶æ€

### å·²å®ŒæˆåŠŸèƒ½

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç½‘è¡¨è§£æ | âœ… å®Œæˆ | æ”¯æŒå­ç”µè·¯ã€å‚æ•°æ›¿æ¢ã€includeã€è¡¨è¾¾å¼æ±‚å€¼ |
| DC ä»¿çœŸ | âœ… å®Œæˆ | Newton è¿­ä»£ + gmin/source stepping |
| TRAN ä»¿çœŸ | âœ… å®Œæˆ | è‡ªé€‚åº”æ­¥é•¿ã€åŠ æƒè¯¯å·®ä¼°è®¡ |
| å™¨ä»¶æ¨¡å‹ | âœ… åŸºç¡€å®Œæˆ | R/C/L/V/I/D/MOS çš„ stamp å®ç° |
| æ±‚è§£å™¨ | âœ… å®Œæˆ | DenseSolver å®ç°ï¼ŒKLU æ¥å£å¯é€‰ |
| ç»“æœè¾“å‡º | âœ… å®Œæˆ | PSF æ–‡æœ¬æ ¼å¼ |
| API æœåŠ¡ | ğŸ”„ æœ€å°å¯ç”¨ | å·²æ”¯æŒ OP è¿è¡Œä¸ç»“æœæŸ¥è¯¢ |
| CLI | ğŸ”„ åŸºç¡€å¯ç”¨ | å¯è¿è¡Œ OP å¹¶è¾“å‡º PSF æ–‡æœ¬ |

### å¾…å®Œå–„åŠŸèƒ½

- è¯­ä¹‰å±•å¼€çš„å®Œæ•´è§„åˆ™ï¼ˆæ›´å¤æ‚çš„å‚æ•°è¡¨è¾¾å¼ã€ä½œç”¨åŸŸè¾¹ç•Œï¼‰
- å—æ§æºé«˜çº§è¯­æ³•ï¼ˆPOLY ç»†èŠ‚ã€å¤šé¡¹å¼å‚æ•°ï¼‰
- API æœåŠ¡å®ç°ä¸äº¤äº’æ¨¡å¼
- BSIM æ¨¡å‹å®Œæ•´å®ç°

## äº¤äº’å¼æ¨¡å¼ä¸ API

äº¤äº’æ¨¡å¼ä¸‹ï¼Œä»¿çœŸå™¨å¯åŠ¨ååªåšå‰ç«¯è§£æä¸æ‹“æ‰‘æ„å»ºï¼Œä¸è‡ªåŠ¨å¼€å§‹ä»¿çœŸã€‚è¿›ç¨‹å¸¸é©»å¹¶é€šè¿‡ API æä¾›ç”µè·¯ä¿¡æ¯è®¿é—®ã€‚ç”¨æˆ·å¯é€šè¿‡ API è§¦å‘ä»¿çœŸï¼Œä»¿çœŸå®Œæˆåè¿›ç¨‹ä¸é€€å‡ºï¼Œç»“æœå¯ç»§ç»­æŸ¥è¯¢ã€‚

### çŠ¶æ€æœº

```
Parsed -> Elaborated -> Ready -> Running -> Completed
```

### ResultStore ç»“æ„

- `run_id`: æ¯æ¬¡ä»¿çœŸå”¯ä¸€æ ‡è¯†
- `analysis_type`: OP / DC sweep / TRAN
- `metadata`: è¿­ä»£æ¬¡æ•°ã€æ”¶æ•›ä¿¡æ¯ã€æ—¶é—´æˆ³
- `data`: èŠ‚ç‚¹ç”µå‹ã€å™¨ä»¶ç”µæµã€æ‰«ææ›²çº¿ç­‰

### API ç«¯ç‚¹ï¼ˆè‰æ¡ˆï¼‰

ç”µè·¯ç»“æ„æŸ¥è¯¢:

- GET /v1/summary
- GET /v1/nodes
- GET /v1/devices
- GET /v1/devices/{id}
- GET /v1/models
- GET /v1/models/{name}
- GET /v1/subckts
- GET /v1/subckts/{name}
- GET /v1/topology
- GET /v1/validate

ä»¿çœŸæ§åˆ¶ä¸ç»“æœè®¿é—®:

- POST /v1/run/op
- POST /v1/run/dc
- POST /v1/run/tran
- GET /v1/runs
- GET /v1/runs/{run_id}
- GET /v1/runs/{run_id}/signals
- GET /v1/runs/{run_id}/waveform?signal=V(n001)
- GET /v1/runs/{run_id}/op
- GET /v1/runs/{run_id}/dc
- GET /v1/runs/{run_id}/tran
- POST /v1/runs/{run_id}/export

## æ“ä½œæŒ‡å—

### 1) è¿è¡Œ CLIï¼ˆæœ€å° OP ç¤ºä¾‹ï¼‰

```
cargo run -p sim-cli -- tests/fixtures/netlists/basic_dc.cir
```

è¾“å‡ºç¤ºä¾‹ï¼ˆèŠ‚ç‚¹ç”µå‹ï¼‰:

```
run status: Converged iterations=2
V(0) = 0
V(in) = 1
V(out) = 0.6666666667
```

### 2) CLI è¾“å‡º PSF æ–‡æœ¬

```
cargo run -p sim-cli -- tests/fixtures/netlists/basic_dc.cir --psf /tmp/basic_dc.psf
```

### 3) å¯åŠ¨ API æœåŠ¡

```
cargo run -p sim-api -- --addr 127.0.0.1:3000
```

### 4) ä½¿ç”¨ netlist å­—ç¬¦ä¸²è§¦å‘ OP

```
curl -X POST http://127.0.0.1:3000/v1/run/op \
  -H "Content-Type: application/json" \
  -d "{\"netlist\":\"V1 in 0 DC 1\\nR1 in out 1k\\nR2 out 0 2k\\n.op\\n.end\\n\"}"
```

### 5) ä½¿ç”¨æ–‡ä»¶è·¯å¾„è§¦å‘ OP

```
curl -X POST http://127.0.0.1:3000/v1/run/op \
  -H "Content-Type: application/json" \
  -d "{\"path\":\"tests/fixtures/netlists/basic_dc.cir\"}"
```

è¯´æ˜:
- `path` åªèƒ½è®¿é—®å½“å‰å·¥ä½œç›®å½•å†…çš„æ–‡ä»¶ï¼ˆå»ºè®®åœ¨ä»“åº“æ ¹ç›®å½•å¯åŠ¨æœåŠ¡ï¼‰
- è¿”å›ç»“æœåŒ…å« `run_id`ã€èŠ‚ç‚¹åä¸ç”µå‹æ•°ç»„

### 6) è§¦å‘ DC æ‰«æ

```
curl -X POST http://127.0.0.1:3000/v1/run/dc \
  -H "Content-Type: application/json" \
  -d "{\"netlist\":\".param V=0\\nV1 in 0 DC 0\\nR1 in 0 1k\\n.dc V1 0 1 0.1\\n.end\\n\"}"
```

ä¹Ÿå¯ä»¥æ˜¾å¼ä¼ å…¥æ‰«æå‚æ•°:

```
curl -X POST http://127.0.0.1:3000/v1/run/dc \
  -H "Content-Type: application/json" \
  -d "{\"path\":\"tests/fixtures/netlists/basic_dc.cir\",\"source\":\"V1\",\"start\":0,\"stop\":1,\"step\":0.1}"
```

### 7) è§¦å‘ TRAN åˆ†æ

```
curl -X POST http://127.0.0.1:3000/v1/run/tran \
  -H "Content-Type: application/json" \
  -d "{\"netlist\":\"V1 in 0 DC 1\\nR1 in 0 1k\\n.tran 1e-6 1e-5\\n.end\\n\"}"
```

### 8) æŸ¥è¯¢è¿è¡Œè®°å½•ä¸å¯¼å‡º PSF

```
curl http://127.0.0.1:3000/v1/runs
curl http://127.0.0.1:3000/v1/runs/0
```

```
curl -X POST http://127.0.0.1:3000/v1/runs/0/export \
  -H "Content-Type: application/json" \
  -d "{\"path\":\"/tmp/run0.psf\"}"
```

### 9) æŸ¥è¯¢ç”µè·¯ç»“æ„

```
curl http://127.0.0.1:3000/v1/summary
curl http://127.0.0.1:3000/v1/nodes
```

## AI äº¤äº’ä¸ CLI

äº¤äº’å¼ç•Œé¢ä¼˜å…ˆåš CLIï¼Œå¹¶ç”± AI ä»£ç†å†³å®šæ˜¯å¦è°ƒç”¨ä»¿çœŸå™¨ APIã€‚æ¨èæ–¹æ¡ˆ:

- ä»¿çœŸå™¨å†…æ ¸: Rust å¸¸é©»è¿›ç¨‹
- CLI + AI ä»£ç†: Python
- é€šè®¯æ–¹å¼: æœ¬åœ° HTTP æˆ– IPC

AI ä»£ç†é€šè¿‡å·¥å…·è°ƒç”¨åè®®è®¿é—® APIï¼Œè·å–ç”µè·¯ä¸ä»¿çœŸç»“æœä¿¡æ¯ï¼Œå¹¶ä»¥è‡ªç„¶è¯­è¨€åé¦ˆã€‚

## Netlist å‰ç«¯è¯­æ³•æ”¯æŒ

### å·²æ”¯æŒ

- æ³¨é‡Šè¡Œ: ä»¥ `*` å¼€å¤´
- ç»­è¡Œ: ä»¥ `+` å¼€å¤´
- è¯­å¥: `.title` `.include` `.param` `.model` `.subckt` `.ends` `.op` `.dc` `.tran` `.end`
- å™¨ä»¶: R C L V I D M E G F H X
- å‚æ•°: `param=expr`ï¼Œå•ä½åç¼€ f p n u m k meg g t
- å­ç”µè·¯: `.subckt` / X å®ä¾‹åŒ–
- è¡¨è¾¾å¼: `+ - * / ^ ( )` ä¸å‡½æ•° `max/min/abs/if`
- å—æ§æº: E/G/F/H åŸºç¡€ POLY è¯­æ³•

### æš‚ä¸æ”¯æŒ

- `.lib` `.if/.elseif/.else/.endif`
- `.measure` `.plot` `.print` (å¯è§£æåå¿½ç•¥)
- `.alter` `.step` `.temp`
- è¡Œä¸ºæº B å…ƒä»¶ã€ä¼ è¾“çº¿ç­‰æ‰©å±•å™¨ä»¶

## MOSFET / BSIM æ¶æ„é¢„ç•™

- æ¨¡å‹å‚æ•°ä¸å®ä¾‹å‚æ•°åˆ†ç¦»
- æ¨¡å‹è®¡ç®—æ ¸å¿ƒç‹¬ç«‹ï¼Œè¾“å…¥ç”µå‹ï¼Œè¾“å‡ºç”µæµä¸å¯¼æ•°
- æ”¯æŒ BSIM3/BSIM4 çš„æ¥å£å ä½ï¼Œåç»­å¡«å……å…¬å¼å®ç°

## Solver è§„åˆ’ï¼ˆKLUï¼‰

ä»¿çœŸå¼•æ“å°†ç›´æ¥ä½¿ç”¨ SuiteSparse çš„ KLU ä½œä¸ºç¨€ç–çº¿æ€§æ±‚è§£å™¨ã€‚

### KLU è°ƒç”¨é“¾

```
1) åˆå§‹åŒ–:
   klu_defaults(&mut common)
   klu_analyze(n, Ap, Ai, &mut common)

2) æ¯æ¬¡è¿­ä»£:
   æ›´æ–° Ax
   klu_factor(Ap, Ai, Ax, symbolic, &mut common)
   klu_solve(symbolic, numeric, n, 1, b, &mut common)

3) ç»“æ„å˜åŒ–æ—¶:
   é‡æ–° klu_analyze
```

### ç¨€ç–çŸ©é˜µæ„å»ºï¼ˆCSCï¼‰

- `n`: çŸ©é˜µç»´åº¦
- `Ap: Vec<i64>`ï¼ˆåˆ—æŒ‡é’ˆï¼Œé•¿åº¦ n+1ï¼‰
- `Ai: Vec<i64>`ï¼ˆè¡Œç´¢å¼•ï¼‰
- `Ax: Vec<f64>`ï¼ˆæ•°å€¼ï¼‰

### æ„å»ºé›†æˆ

- ä½¿ç”¨ `--features klu` å¯ç”¨ KLU
- éœ€è¦è®¾ç½® `KLU_LIB_DIR` æˆ– `SUITESPARSE_DIR`

## ç›®å½•ç»“æ„

```
myspice/
â”œâ”€â”€ Cargo.toml                    # Workspace é…ç½®
â”œâ”€â”€ README.md                     # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ crates/
â”‚   â”œâ”€â”€ sim-core/                 # ä»¿çœŸæ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ build.rs              # KLU æ„å»ºè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ netlist.rs        # ç½‘è¡¨è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ circuit.rs        # ç”µè·¯ç»“æ„
â”‚   â”‚   â”‚   â”œâ”€â”€ topology.rs       # æ‹“æ‰‘åˆ†æ
â”‚   â”‚   â”‚   â”œâ”€â”€ mna.rs            # MNA æ„å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ stamp.rs          # å™¨ä»¶ Stamp
â”‚   â”‚   â”‚   â”œâ”€â”€ solver.rs         # çº¿æ€§æ±‚è§£
â”‚   â”‚   â”‚   â”œâ”€â”€ newton.rs         # éçº¿æ€§è¿­ä»£
â”‚   â”‚   â”‚   â”œâ”€â”€ engine.rs         # ä»¿çœŸå¼•æ“
â”‚   â”‚   â”‚   â”œâ”€â”€ analysis.rs       # åˆ†æé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ result_store.rs   # ç»“æœå­˜å‚¨
â”‚   â”‚   â”‚   â”œâ”€â”€ psf.rs            # PSF è¾“å‡º
â”‚   â”‚   â”‚   â””â”€â”€ session.rs        # ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ tests/                # å•å…ƒæµ‹è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ sim-devices/              # å™¨ä»¶æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ model.rs          # æ¨¡å‹ trait
â”‚   â”‚   â”‚   â”œâ”€â”€ passive.rs        # R/C/L
â”‚   â”‚   â”‚   â”œâ”€â”€ source.rs         # V/I
â”‚   â”‚   â”‚   â”œâ”€â”€ diode.rs          # äºŒæç®¡
â”‚   â”‚   â”‚   â””â”€â”€ mosfet.rs         # MOSFET
â”‚   â”‚   â””â”€â”€ tests/
â”‚   â”‚
â”‚   â”œâ”€â”€ sim-api/                  # API å±‚
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.rs         # API Schema
â”‚   â”‚   â”‚   â”œâ”€â”€ session_api.rs    # Session API
â”‚   â”‚   â”‚   â””â”€â”€ http.rs           # HTTP æœåŠ¡
â”‚   â”‚   â””â”€â”€ tests/
â”‚   â”‚
â”‚   â””â”€â”€ sim-cli/                  # CLI å·¥å…·
â”‚       â”œâ”€â”€ Cargo.toml
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â””â”€â”€ main.rs
â”‚       â””â”€â”€ tests/
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ fixtures/netlists/        # æµ‹è¯•ç½‘è¡¨
â”‚   â”‚   â”œâ”€â”€ basic_dc.cir
â”‚   â”‚   â”œâ”€â”€ include_parent.cir
â”‚   â”‚   â””â”€â”€ include_child.cir
â”‚   â””â”€â”€ run_spice_datasets.py     # æ‰¹é‡æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ ai-agent/                 # Python AI ä»£ç†
â”‚   â”‚   â”œâ”€â”€ cli.py
â”‚   â”‚   â””â”€â”€ tests/
â”‚   â””â”€â”€ gui/                      # GUIï¼ˆå¾…å®ç°ï¼‰
â”‚       â””â”€â”€ README.md
â”‚
â””â”€â”€ docs/                         # æ–‡æ¡£
    â”œâ”€â”€ myspice_user_manual.md
    â””â”€â”€ solver_klu_plan.md
```

## æµ‹è¯•ç»“æ„

- `crates/sim-core/tests`: Rust å•å…ƒä¸é›†æˆæµ‹è¯•
- `crates/sim-devices/tests`: å™¨ä»¶æ¨¡å‹å•å…ƒæµ‹è¯•
- `crates/sim-api/tests`: API å±‚å•å…ƒæµ‹è¯•
- `crates/sim-cli/tests`: CLI å•å…ƒæµ‹è¯•
- `tests/fixtures/netlists`: ç½‘è¡¨ fixture ç”¨ä¾‹
- `tests/run_spice_datasets.py`: è¿è¡Œ spice-datasets çš„æ‰¹é‡ smoke æµ‹è¯•
- `tools/ai-agent/tests`: Python CLI/ä»£ç†æµ‹è¯•
- å¤–éƒ¨æ•°æ®é›†: `../spice-datasets` (æµ‹è¯•ç”¨ä¾‹å¼•ç”¨)

### è¿è¡Œæµ‹è¯•

```bash
# åœ¨ WSL æˆ– Linux ç¯å¢ƒä¸­
cargo test --workspace

# æ’é™¤éœ€è¦å¤–éƒ¨æ•°æ®é›†çš„æµ‹è¯•
cargo test --workspace --exclude sim-cli
```

## é‡Œç¨‹ç¢‘è®¡åˆ’

### W0: é¡¹ç›®è„šæ‰‹æ¶ä¸ç›®å½•ç»“æ„ âœ…
ç›®æ ‡: å»ºç«‹ workspace å’ŒåŸºç¡€æ¨¡å—è¾¹ç•Œï¼Œæ‰“é€šæœ€å°æ„å»ºé“¾è·¯ã€‚  
éªŒæ”¶æ ‡å‡†: èƒ½ç¼–è¯‘é€šè¿‡ï¼Œæ ¸å¿ƒ crate å¯è¢«ç‹¬ç«‹å¼•ç”¨ã€‚  
äº¤ä»˜ç‰©: ç›®å½•ç»“æ„ã€åŸºç¡€é…ç½®ã€æœ€å°å¯è¿è¡Œå…¥å£ã€‚

### W1: ç½‘è¡¨è§£æä¸æ ¸å¿ƒæ•°æ®ç»“æ„ âœ…
ç›®æ ‡: å®Œæˆ SPICE ç½‘è¡¨è§£æã€è¯­ä¹‰å±•å¼€å…¥å£ä¸åŸºç¡€å™¨ä»¶æ•°æ®ç»“æ„ï¼Œå½¢æˆä»¿çœŸæ ¸å¿ƒæµç¨‹éª¨æ¶ã€‚  
éªŒæ”¶æ ‡å‡†: èƒ½è§£æå…¸å‹ç½‘è¡¨å¹¶ç”Ÿæˆå±•å¼€åçš„å®ä¾‹æ¸…å•ä¸æ‹“æ‰‘ä¿¡æ¯ã€‚  
äº¤ä»˜ç‰©: è§£æå™¨ã€ç¬¦å·è¡¨ã€åŸºç¡€å™¨ä»¶ç»“æ„ä¸æ ¸å¿ƒæµç¨‹æ–‡æ¡£ã€‚

### W2: DC ä»¿çœŸå¼•æ“ä¸ MOSFET æ¡†æ¶ ğŸ”„ (è¿›è¡Œä¸­)
ç›®æ ‡: æ‰“é€š DC ä»¿çœŸæ ¸å¿ƒèƒ½åŠ›ï¼Œå®Œæˆ MOSFET modeling æ¡†æ¶ã€äº¤äº’ API ä¸ ResultStoreã€‚  
éªŒæ”¶æ ‡å‡†: æ”¯æŒåŸºç¡€å™¨ä»¶ DC ä»¿çœŸå¹¶è¾“å‡ºç»“æ„åŒ–ç»“æœï¼ŒMOSFET æ¥å£å¯è¢«è°ƒç”¨ã€‚  
äº¤ä»˜ç‰©: DC æ±‚è§£é“¾è·¯ã€MOSFET æ¥å£å ä½ã€API åŸå‹ä¸ç»“æœå­˜å‚¨æ¨¡å—ã€‚

### W3: CLI ä¸äº¤äº’ä½“éªŒ + æ³¢å½¢è¾“å‡º â³
ç›®æ ‡: å®Œæˆ CLI + AI ä»£ç†çš„äº¤äº’æµç¨‹ï¼Œæä¾›ç»“æœæŸ¥è¯¢ä¸æ³¢å½¢è¾“å‡ºèƒ½åŠ›ã€‚  
éªŒæ”¶æ ‡å‡†: CLI èƒ½é©±åŠ¨ä»¿çœŸä¸æŸ¥è¯¢ç»“æœï¼Œæ”¯æŒ PSF æ–‡æœ¬è¾“å‡ºã€‚  
äº¤ä»˜ç‰©: CLI ç¨‹åºã€äº¤äº’åè®®ã€PSF æ–‡æœ¬è¾“å‡ºå®ç°ä¸ç¤ºä¾‹ç”¨ä¾‹ã€‚

### W4: é¦–ç‰ˆä¼˜åŒ–ä¸ç¨³å®šæ€§å®Œå–„ â³
ç›®æ ‡: å¼ºåŒ–æ€§èƒ½ã€ç¨³å®šæ€§ä¸é”™è¯¯è¯Šæ–­ï¼Œå®Œæˆé¦–ç‰ˆå¯ç”¨æ€§æ‰“ç£¨ã€‚  
éªŒæ”¶æ ‡å‡†: å…¸å‹å°è§„æ¨¡ç½‘è¡¨ç¨³å®šè¿è¡Œï¼Œé”™è¯¯æŠ¥å‘Šæ¸…æ™°ï¼Œè¿è¡Œæ€§èƒ½å¯æ¥å—ã€‚  
äº¤ä»˜ç‰©: æ€§èƒ½ä¼˜åŒ–ä¸è¯Šæ–­æ”¹è¿›ã€å›å½’ç”¨ä¾‹ä¸é˜¶æ®µæ€»ç»“ã€‚

## ä¸‹ä¸€æ­¥ Todo

- [x] å‚æ•°è¡¨è¾¾å¼å‡çº§ï¼ˆå‡½æ•°ã€æ¡ä»¶ï¼‰
- [x] å­ç”µè·¯å†… `.param` å±€éƒ¨ä½œç”¨åŸŸ + åµŒå¥—å­ç”µè·¯
- [ ] æ›´å®Œå–„çš„å—æ§æºè¯­æ³•ï¼ˆPOLY ç»†èŠ‚ï¼‰
- [ ] API æœåŠ¡å®ç°
- [ ] BSIM æ¨¡å‹å¡«å……

## GUI è§„åˆ’ï¼ˆåç»­é˜¶æ®µï¼‰

æ¨èä½¿ç”¨ PySide6 (Qt for Python):

- è·¨å¹³å°æˆç†Ÿã€æ§ä»¶ä¸°å¯Œ
- é€‚åˆå¤æ‚å¸ƒå±€ä¸æ³¢å½¢/å›¾å½¢æ˜¾ç¤º

GUI ç»„ä»¶å»ºè®®:

- å‘½ä»¤è¾“å…¥é¢æ¿ (Command Panel)
- AI è¾“å‡º/æ—¥å¿—é¢æ¿ (Chat/Log Panel)
- ç”µè·¯ç¤ºæ„å›¾é¢æ¿ (Schematic Viewer)
- ç»“æœä¸è¡¨æ ¼é¢æ¿ (Result Panel)

### åŸºäº Netlist çš„ Schematic æ˜¾ç¤º

ç¤ºæ„å›¾ä¸æ˜¯ä¼ ç»Ÿè®¾è®¡çº§ schematicï¼Œè€Œæ˜¯ä» netlist è‡ªåŠ¨ç”Ÿæˆçš„æ‹“æ‰‘è§†å›¾:

```
Netlist -> æ‹“æ‰‘å›¾ -> è‡ªåŠ¨å¸ƒå±€ -> Qt ç»˜åˆ¶
```

å¸ƒå±€å»ºè®®:
- ä¼˜å…ˆä½¿ç”¨ Graphviz/dot ç”Ÿæˆåæ ‡
- å°è§„æ¨¡ç”µè·¯å¯ç”¨ç®€åŒ–å¸ƒå±€ç®—æ³•

ç»˜åˆ¶å»ºè®®:
- QGraphicsView / QGraphicsScene
- å™¨ä»¶ç¬¦å·ä¸è¿çº¿åˆ†åˆ«ä½œä¸ºå›¾å…ƒ
